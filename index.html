<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi dengan GPS</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --gray: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .form-section {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .form-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--secondary);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .signature-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
        }
        
        #signatureCanvas {
            width: 100%;
            height: 150px;
            background-color: #f9f9f9;
            cursor: crosshair;
            border-radius: 6px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #clearBtn {
            background: var(--warning);
            color: white;
        }
        
        #clearBtn:hover {
            background: #e01a6f;
        }
        
        #submitBtn {
            background: var(--primary);
            color: white;
            flex: 1;
        }
        
        #submitBtn:hover {
            background: var(--secondary);
        }
        
        .export-btn {
            background: var(--success);
            color: white;
            margin-top: 15px;
            width: 100%;
        }
        
        .export-btn:hover {
            background: #3ab0d6;
        }
        
        .data-section {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .data-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--secondary);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #attendanceList {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .attendance-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .attendance-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .attendance-name {
            font-weight: 600;
            color: var(--secondary);
        }
        
        .attendance-time {
            color: var(--gray);
            font-size: 14px;
        }
        
        .attendance-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        
        .signature-preview {
            margin-top: 10px;
            border-top: 1px dashed #ddd;
            padding-top: 10px;
        }
        
        .signature-preview img {
            max-width: 100%;
            height: 50px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .empty-message {
            text-align: center;
            color: var(--gray);
            font-style: italic;
            padding: 30px;
        }
        
        .instructions {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #ff9800;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        .gps-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gps-loading {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        
        .gps-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .gps-error {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .location-info {
            font-size: 14px;
            margin-top: 5px;
        }
        
        .map-link {
            color: var(--primary);
            text-decoration: none;
            margin-top: 5px;
            display: inline-block;
            font-weight: 600;
        }
        
        .map-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sistem Absensi dengan GPS</h1>
            <p class="description">Catat kehadiran dengan tanda tangan digital dan pelacakan lokasi</p>
        </header>
        
        <div class="content">
            <div class="form-section">
                <h2 class="form-title">Form Absensi</h2>
                
                <div id="gpsStatus" class="gps-status gps-loading">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <span>Mendeteksi lokasi...</span>
                </div>
                
                <form id="attendanceForm">
                    <div class="form-group">
                        <label for="name">Nama Lengkap:</label>
                        <input type="text" id="name" placeholder="Masukkan nama lengkap" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nip">NIP:</label>
                        <input type="text" id="nip" placeholder="Masukkan NIP" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">No. HP:</label>
                        <input type="text" id="phone" placeholder="Masukkan nomor HP" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agency">Instansi:</label>
                        <input type="text" id="agency" placeholder="Masukkan nama instansi" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signature">Tanda Tangan:</label>
                        <div class="signature-container">
                            <canvas id="signatureCanvas"></canvas>
                        </div>
                        <div class="button-group">
                            <button type="button" id="clearBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                                Hapus
                            </button>
                            <button type="submit" id="submitBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                                </svg>
                                Simpan Absensi
                            </button>
                        </div>
                    </div>
                </form>
                
                <button type="button" id="exportBtn" class="export-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Ekspor ke CSV untuk WPS Office
                </button>
                
                <div class="instructions">
                    <h3>Cara menggunakan di WPS Office:</h3>
                    <ol>
                        <li>Klik tombol "Ekspor ke CSV" di atas</li>
                        <li>Simpan file CSV di perangkat Anda</li>
                        <li>Buka WPS Office</li>
                        <li>Buka file CSV yang telah disimpan</li>
                        <li>Data absensi akan terbuka dalam format spreadsheet</li>
                    </ol>
                </div>
            </div>
            
            <div class="data-section">
                <h2 class="form-title">Daftar Hadir</h2>
                <div id="attendanceList">
                    <div class="empty-message">Belum ada data absensi</div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 Sistem Absensi dengan GPS | Data disimpan secara lokal di browser</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            const clearBtn = document.getElementById('clearBtn');
            const form = document.getElementById('attendanceForm');
            const attendanceList = document.getElementById('attendanceList');
            const exportBtn = document.getElementById('exportBtn');
            const gpsStatus = document.getElementById('gpsStatus');
            
            let currentLocation = null;
            
            // Initialize GPS
            initGPS();
            
            // Set canvas size properly
            function resizeCanvas() {
                const ratio = window.devicePixelRatio || 1;
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                clearSignature();
            }
            
            // Initial resize
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // Event listeners for drawing
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile devices
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', handleTouchEnd);
            
            clearBtn.addEventListener('click', clearSignature);
            form.addEventListener('submit', handleSubmit);
            exportBtn.addEventListener('click', exportToCSV);
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                ctx.beginPath();
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';
                
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup');
                canvas.dispatchEvent(mouseEvent);
            }
            
            function clearSignature() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            function initGPS() {
                if (!navigator.geolocation) {
                    gpsStatus.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                        </svg>
                        <span>Geolocation tidak didukung oleh browser ini</span>
                    `;
                    gpsStatus.className = 'gps-status gps-error';
                    return;
                }
                
                gpsStatus.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    <span>Mendeteksi lokasi...</span>
                `;
                gpsStatus.className = 'gps-status gps-loading';
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // Get address from coordinates (reverse geocoding)
                        getAddressFromCoordinates(latitude, longitude);
                    },
                    function(error) {
                        let errorMessage = "Tidak dapat mendapatkan lokasi";
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Izin akses lokasi ditolak";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Informasi lokasi tidak tersedia";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Permintaan lokasi timeout";
                                break;
                        }
                        
                        gpsStatus.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16zM7 6a1 1 0 0 0-2 0v4a1 1 0 0 0 2 0V6zm1 5a1 1 0 1 0-2 0 1 1 0 0 0 2 0z"/>
                            </svg>
                            <span>${errorMessage}</span>
                        `;
                        gpsStatus.className = 'gps-status gps-error';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }
            
            function getAddressFromCoordinates(lat, lng) {
                // Using OpenStreetMap Nominatim for reverse geocoding
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                    .then(response => response.json())
                    .then(data => {
                        const address = data.display_name || "Alamat tidak ditemukan";
                        
                        currentLocation = {
                            latitude: lat,
                            longitude: lng,
                            address: address
                        };
                        
                        gpsStatus.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                            </svg>
                            <div>
                                <div>Lokasi terdeteksi</div>
                                <div class="location-info">${address.substring(0, 60)}...</div>
                                <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=17/${lat}/${lng}" 
                                   target="_blank" class="map-link">Lihat di Peta</a>
                            </div>
                        `;
                        gpsStatus.className = 'gps-status gps-success';
                    })
                    .catch(error => {
                        currentLocation = {
                            latitude: lat,
                            longitude: lng,
                            address: "Alamat tidak dapat ditemukan"
                        };
                        
                        gpsStatus.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                            </svg>
                            <div>
                                <div>Lokasi terdeteksi (tanpa alamat)</div>
                                <div class="location-info">Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</div>
                                <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=17/${lat}/${lng}" 
                                   target="_blank" class="map-link">Lihat di Peta</a>
                            </div>
                        `;
                        gpsStatus.className = 'gps-status gps-success';
                    });
            }
            
            function handleSubmit(e) {
                e.preventDefault();
                
                if (!currentLocation) {
                    alert('Harap tunggu hingga lokasi terdeteksi!');
                    return;
                }
                
                const name = document.getElementById('name').value;
                const nip = document.getElementById('nip').value;
                const phone = document.getElementById('phone').value;
                const agency = document.getElementById('agency').value;
                
                // Check if signature is provided
                const signatureData = canvas.toDataURL();
                const blankCanvas = document.createElement('canvas');
                blankCanvas.width = canvas.width;
                blankCanvas.height = canvas.height;
                
                if (signatureData === blankCanvas.toDataURL()) {
                    alert('Harap berikan tanda tangan!');
                    return;
                }
                
                // Save attendance
                saveAttendance(name, nip, phone, agency, signatureData);
                
                // Reset form
                form.reset();
                clearSignature();
            }
            
            function saveAttendance(name, nip, phone, agency, signature) {
                // Get existing data or initialize empty array
                let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
                
                // Create new attendance entry
                const newEntry = {
                    id: Date.now(),
                    name,
                    nip,
                    phone,
                    agency,
                    signature,
                    location: currentLocation,
                    timestamp: new Date().toLocaleString('id-ID')
                };
                
                // Add to array and save
                attendanceData.unshift(newEntry);
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                // Update display
                displayAttendance();
            }
            
            function displayAttendance() {
                const attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
                
                if (attendanceData.length === 0) {
                    attendanceList.innerHTML = '<div class="empty-message">Belum ada data absensi</div>';
                    return;
                }
                
                attendanceList.innerHTML = '';
                
                attendanceData.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'attendance-item';
                    
                    let locationText = "Lokasi tidak tersedia";
                    let mapLink = "";
                    
                    if (entry.location) {
                        locationText = entry.location.address.substring(0, 80) + (entry.location.address.length > 80 ? "..." : "");
                        mapLink = `<a href="https://www.openstreetmap.org/?mlat=${entry.location.latitude}&mlon=${entry.location.longitude}#map=17/${entry.location.latitude}/${entry.location.longitude}" 
                                   target="_blank" class="map-link">Lihat di Peta</a>`;
                    }
                    
                    item.innerHTML = `
                        <div class="attendance-header">
                            <div class="attendance-name">${entry.name}</div>
                            <div class="attendance-time">${entry.timestamp}</div>
                        </div>
                        <div class="attendance-details">
                            <div><strong>NIP:</strong> ${entry.nip}</div>
                            <div><strong>No. HP:</strong> ${entry.phone}</div>
                            <div><strong>Instansi:</strong> ${entry.agency}</div>
                            <div><strong>Lokasi:</strong> ${locationText}</div>
                        </div>
                        ${mapLink}
                        <div class="signature-preview">
                            <strong>Tanda Tangan:</strong>
                            <img src="${entry.signature}" alt="Tanda Tangan">
                        </div>
                    `;
                    attendanceList.appendChild(item);
                });
            }
            
            function exportToCSV() {
                const attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
                
                if (attendanceData.length === 0) {
                    alert('Tidak ada data absensi untuk diekspor!');
                    return;
                }
                
                // Create CSV content
                let csvContent = "Nama,NIP,No. HP,Instansi,Waktu,Latitude,Longitude,Alamat,Tanda Tangan (Base64)\n";
                
                attendanceData.forEach(entry => {
                    const location = entry.location || {};
                    csvContent += `"${entry.name}","${entry.nip}","${entry.phone}","${entry.agency}","${entry.timestamp}",${location.latitude || ""},${location.longitude || ""},"${(location.address || "").replace(/"/g, '""')}","${entry.signature}"\n`;
                });
                
                // Create download link
                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "absensi_gps.csv");
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                document.body.removeChild(link);
            }
            
            // Initial display
            displayAttendance();
        });
    </script>
</body>
</html>