<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi dengan GPS</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --gray: #6c757d;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {max-width: 1000px;margin: auto;background: #fff;border-radius: 15px;box-shadow: 0 10px 30px rgba(0,0,0,0.1);}
        header {background: var(--primary);color: #fff;padding: 25px;text-align: center;}
        h1 {margin-bottom: 10px;}
        .content {padding: 25px;display: grid;grid-template-columns: 1fr 1fr;gap: 25px;}
        @media (max-width:768px){.content{grid-template-columns:1fr;}}
        .form-section,.data-section{background: var(--light);padding:20px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.05);}
        .form-title{font-size:20px;margin-bottom:20px;color:var(--secondary);border-bottom:2px solid var(--accent);padding-bottom:8px;}
        .form-group{margin-bottom:18px;}
        label{display:block;margin-bottom:6px;font-weight:600;}
        input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:8px;font-size:16px;}
        input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(67,97,238,0.2);}
        #signatureCanvas{width:100%;height:150px;background:#f9f9f9;border-radius:6px;cursor:crosshair;}
        button{padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;}
        #clearBtn{background:var(--warning);color:#fff;}#clearBtn:hover{background:#e01a6f;}
        #submitBtn{background:var(--primary);color:#fff;width:100%;}#submitBtn:hover{background:var(--secondary);}
        .gps-status{padding:10px;border-radius:8px;margin-bottom:15px;}
        .gps-loading{background:#e3f2fd;color:#0d47a1;}
        .gps-success{background:#e8f5e9;color:#2e7d32;}
        .gps-error{background:#ffebee;color:#c62828;}
        .attendance-item{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px;border-left:4px solid var(--primary);box-shadow:0 2px 5px rgba(0,0,0,0.05);}
        .attendance-header{display:flex;justify-content:space-between;margin-bottom:10px;}
        .attendance-name{font-weight:600;color:var(--secondary);}
        .attendance-time{color:var(--gray);font-size:14px;}
        .attendance-details{display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:14px;}
        .signature-preview img{height:50px;border:1px solid #ddd;border-radius:4px;}
        .empty-message{text-align:center;color:var(--gray);font-style:italic;padding:30px;}
        footer{text-align:center;padding:20px;color:var(--gray);font-size:14px;}
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Sistem Absensi dengan GPS</h1>
        <p>Catat kehadiran dengan tanda tangan digital dan lokasi otomatis</p>
    </header>

    <div class="content">
        <!-- Form Absensi -->
        <div class="form-section">
            <h2 class="form-title">Form Absensi</h2>
            <div id="gpsStatus" class="gps-status gps-loading">Mendeteksi lokasi...</div>

            <form id="attendanceForm">
                <div class="form-group">
                    <label for="name">Nama Lengkap:</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="nip">NIP:</label>
                    <input type="text" id="nip" required>
                </div>
                <div class="form-group">
                    <label for="phone">No. HP:</label>
                    <input type="text" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="agency">Instansi:</label>
                    <input type="text" id="agency" required>
                </div>
                <div class="form-group">
                    <label for="signature">Tanda Tangan:</label>
                    <canvas id="signatureCanvas"></canvas>
                    <button type="button" id="clearBtn">Hapus Tanda Tangan</button>
                </div>
                <button type="submit" id="submitBtn">Simpan Absensi</button>
            </form>
        </div>

        <!-- Data Absensi -->
        <div class="data-section">
            <h2 class="form-title">Daftar Hadir (Browser Anda)</h2>
            <div id="attendanceList"><div class="empty-message">Belum ada data absensi</div></div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 Sistem Absensi GPS | Data utama tersimpan di Google Sheets</p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const canvas=document.getElementById('signatureCanvas');
    const ctx=canvas.getContext('2d');
    const form=document.getElementById('attendanceForm');
    const list=document.getElementById('attendanceList');
    const clearBtn=document.getElementById('clearBtn');
    const gpsStatus=document.getElementById('gpsStatus');
    let currentLocation=null;

    // Resize canvas
    function resizeCanvas(){canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;ctx.clearRect(0,0,canvas.width,canvas.height);}
    resizeCanvas();window.addEventListener('resize',resizeCanvas);

    // Drawing
    let drawing=false;canvas.addEventListener('mousedown',e=>{drawing=true;ctx.moveTo(e.offsetX,e.offsetY);});
    canvas.addEventListener('mousemove',e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}});
    canvas.addEventListener('mouseup',()=>drawing=false);
    canvas.addEventListener('mouseout',()=>drawing=false);
    clearBtn.onclick=()=>ctx.clearRect(0,0,canvas.width,canvas.height);

    // GPS
    if(navigator.geolocation){
        gpsStatus.textContent="Mendeteksi lokasi...";
        navigator.geolocation.getCurrentPosition(pos=>{
            const lat=pos.coords.latitude,lng=pos.coords.longitude;
            currentLocation={latitude:lat,longitude:lng,address:`Lat: ${lat}, Lng: ${lng}`};
            gpsStatus.textContent="Lokasi terdeteksi";
            gpsStatus.className="gps-status gps-success";
        },()=>{gpsStatus.textContent="Lokasi tidak tersedia";gpsStatus.className="gps-status gps-error";});
    }

    // Submit
    form.addEventListener('submit',function(e){
        e.preventDefault();
        if(!currentLocation){alert("Lokasi belum terdeteksi");return;}

        const data={
            name:document.getElementById('name').value,
            nip:document.getElementById('nip').value,
            phone:document.getElementById('phone').value,
            agency:document.getElementById('agency').value,
            signature:canvas.toDataURL(),
            location:currentLocation,
            timestamp:new Date().toLocaleString('id-ID')
        };

        // Simpan ke Google Sheets
        fetch("https://script.google.com/macros/s/AKfycbxRW30DGQuvohtlM0Oo1Egbz81Rd9x3ZzpZrptN8rMgvuXPz1o89KOjIfTQcLlX0UcB/exec",{
            method:"POST",
            body:JSON.stringify(data)
        }).then(()=>{
            alert("Absensi berhasil disimpan ke Google Sheets!");
            saveLocal(data);
        }).catch(err=>{
            console.error(err);
            alert("Gagal menyimpan, cek koneksi.");
        });

        form.reset();ctx.clearRect(0,0,canvas.width,canvas.height);
    });

    // Simpan lokal (untuk preview di browser)
    function saveLocal(entry){
        let db=JSON.parse(localStorage.getItem('attendanceData'))||[];
        db.unshift(entry);localStorage.setItem('attendanceData',JSON.stringify(db));
        renderList();
    }

    function renderList(){
        let db=JSON.parse(localStorage.getItem('attendanceData'))||[];
        if(db.length===0){list.innerHTML='<div class="empty-message">Belum ada data absensi</div>';return;}
        list.innerHTML="";
        db.forEach(en=>{
            const item=document.createElement('div');item.className="attendance-item";
            item.innerHTML=`
              <div class="attendance-header">
                <div class="attendance-name">${en.name}</div>
                <div class="attendance-time">${en.timestamp}</div>
              </div>
              <div class="attendance-details">
                <div><b>NIP:</b> ${en.nip}</div>
                <div><b>HP:</b> ${en.phone}</div>
                <div><b>Instansi:</b> ${en.agency}</div>
                <div><b>Lokasi:</b> ${en.location.address}</div>
              </div>
              <div class="signature-preview"><b>Tanda Tangan:</b><br><img src="${en.signature}"></div>
            `;
            list.appendChild(item);
        });
    }
    renderList();
});
</script>
</body>
</html>
